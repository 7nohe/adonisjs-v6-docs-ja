---
summary: Hot module replacement（HMR）を使用して、AdonisJSアプリケーションを再起動せずに更新します。

---

# Hot module replacement

Hot module replacement（HMR）は、JavaScriptモジュールを修正後に再読み込みするプロセスを指します。プロセス全体を再起動する必要がないため、HMRは通常、より迅速なフィードバックループをもたらします。

HMRという用語は、Viteなどのツールがモジュールをホットリロードし、既存の状態を維持しながらウェブページに変更を適用するフロントエンドエコシステムで長年使用されてきました。

ただし、AdonisJSによるHMRは、ViteやWebpackなどのツールとは大きく異なり、はるかにシンプルです。HMRの目的は、高速なリロードを提供することです。

## キーコンセプト

### ブラウザへの更新は伝播されません

AdonisJSはバックエンドフレームワークであるため、フロントエンドアプリケーションの状態を維持したり、ウェブページにCSSを適用したりすることは担当していません。したがって、私たちのHMR統合はフロントエンドアプリケーションと通信し、その状態を調整することはできません。

実際、すべてのAdonisJSアプリケーションがブラウザでレンダリングされるウェブアプリケーションではありません。多くのアプリケーションは純粋なJSON APIを作成するためにAdonisJSを使用しており、彼らも私たちのHMR統合の恩恵を受けることができます。

### 動的インポートのみ動作します
多くのHMRツールは、コード変換を使用してコンパイルされた出力に追加のコードを注入します。AdonisJSでは、トランスパイラにはあまり賛成しておらず、プラットフォームをそのまま受け入れることを常に心がけています。したがって、私たちのHMRのアプローチは[Node.jsのローダーフック](https://nodejs.org/api/module.html#customization-hooks)を使用し、動的インポートのみ動作します。

**良いニュースは、AdonisJSアプリケーションのすべての重要な部分がデフォルトで動的にインポートされる**ということです。たとえば、コントローラ、ミドルウェア、イベントリスナーなどはすべて動的にインポートされるため、アプリのコードを変更することなく、今日からHMRを活用できます。

動的にインポートされるモジュールのインポートは、トップレベルに配置することもできます。たとえば、ルートファイルで動的にインポートされるコントローラは、バリデータ、TSXファイル、モデル、サービスのトップレベルのインポートを持つことができ、すべてがHMRの恩恵を受けます。

## 使用法
すべての公式スターターキットはデフォルトでHMRを使用するように更新されています。ただし、既存のアプリケーションの場合は、次のようにHMRを設定できます。

開発依存関係として[hot-hook](https://github.com/Julien-R44/hot-hook) npmパッケージをインストールします。AdonisJSコアチームがこのパッケージを作成しましたが、AdonisJSアプリケーションの外部でも使用できます。

```sh
npm i -D hot-hook
```

次に、以下の設定を`package.json`ファイルにコピーしてください。`boundaries`プロパティは、HMRの対象とするグロブパターンの配列を受け入れます。

```json
{
  "hotHook": {
    "boundaries": [
      "./app/controllers/**/*.ts",
      "./app/middleware/*.ts"
    ]
  }
}
```

設定が完了したら、`--hmr`フラグを使用して開発サーバーを起動できます。

```sh
node ace serve --hmr
```

また、`package.json`ファイル内の`dev`スクリプトをこの新しいフラグを使用するように更新することもできます。

```json
{
  "scripts": {
    "dev": "node ace serve --hmr"
  }
}
```

## フルリロードとHMR

:::note

このセクションでは、`hot-hook`の基本的な動作について説明します。詳細な技術的な理論を読む気分でない場合は、スキップしても構いません 🤓

または、パッケージの[READMEファイル](https://github.com/Julien-R44/hot-hook)を参照して、さらに詳しい説明を読むこともできます。

:::

完全なリロード（プロセスの再起動）とモジュールのホットリロードがAdonisJSでいつ行われるかを理解しましょう。

### 依存関係ツリーの作成
`--hmr`フラグを使用すると、AdonisJSは`hot-hook`を使用して、`bin/server.ts`ファイルを起点にアプリケーションの依存関係ツリーを作成し、この依存関係ツリーに含まれるすべてのファイルを監視します。

つまり、アプリケーションのソースコードにTypeScriptファイルを作成しても、アプリ内のどこにもインポートされない場合、このファイルはリロードをトリガーしません。ファイルが存在しないかのように無視されます。

### 境界の識別
次に、`hot-hook`は設定の`boundaries`配列を使用して、HMRの対象となるファイルを特定します。

一般的なガイドラインとして、設定ファイル、サービスプロバイダ、プリロードファイルを境界として登録しないでください。これは、これらのファイルが通常、いくつかの副作用を引き起こすためです。以下にいくつかの例を示します。

- `config/database.ts`ファイルはデータベースとの接続を確立します。このファイルをホットリロードすると、既存の接続が閉じられ、再作成されます。同じことは、追加の複雑さを加えずにプロセス全体を再起動することでも実現できます。

- `start/routes.ts`ファイルはルートを登録するために使用されます。このファイルをホットリロードすると、フレームワークで登録されている既存のルートが削除され、再登録されます。再起動することは簡単です。

言い換えれば、HTTPリクエスト中にインポート/実行されるモジュールはHMRの境界に含めるべきであり、アプリケーションの起動に必要なモジュールは含めるべきではありません。

### リロードの実行
`hot-hook`が境界を特定した後、境界に属する動的にインポートされたモジュールに対してHMRを実行し、それ以外のファイルに対してはプロセスを再起動します。

